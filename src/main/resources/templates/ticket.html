<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Welcome User</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Custom Styles */
        body {
            padding: 20px;
        }

        .container-form {
            max-width: 80%;
            margin: 50px auto 20px; /* Add gap between navbar and form */
            background: #f0f0f0; /* Change background color */
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 0px 20px 0px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
            padding: 5px;
            width: 50%;
        }
        .form-group1 {
            margin-bottom: 15px;
            padding: 5px;
            /* Adjust the width as needed */
            width: calc(25% - 10px); /* Set each form group to occupy one-third of the container width */
        }
        #pricePerPerson {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #f9f9f9; /* Background color for read-only input */
            cursor: not-allowed; /* Disable cursor for read-only input */
        }


        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        input[type="submit"] {
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            width: 20%; /* Adjust the width as needed */
            margin-left: auto; /* Align to the right */
            display: block; /* Ensure it is a block-level element */
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }

        .add-button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .separator {
            width: 100%;
            border-top: 2px solid #ccc;
            margin: 20px 0;
        }

        h3 {
            text-align: center; /* Center align the header */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .form-group-half {
            width: calc(25% - 10px);
            /* Adjust width as needed and consider margin */
        }

    </style>
</head>
<body>

<div th:replace="fragments/userNaveMenu :: header"></div>

<div class="container-form">
    <h3>Welcome to <span th:text="${establishment.name}"></span></h3> <!-- Centered header -->

    <form th:action="@{'/processCheckoutForm/' + ${establishment.establishmentId}}" th:object="${theTicket}" method="POST" onsubmit="return validateForm()">
    <input type="hidden" id="establishmentId" th:name="establishmentId" th:value="${establishment.establishmentId}" />
        <hr class="separator">

        <fieldset>
            <legend>Personal Information</legend>
            <div class="form-row">
                <div class="form-group">
                    <label for="dateTime">Date:<span class="text-danger">*</span></label>
                    <input type="date" id="dateTime" th:field="*{dateTime}" required/>
                </div>
                <div class="form-group">
                    <label for="name">Name:<span class="text-danger">*</span></label>
                    <input type="text" id="name" th:field="*{name}" required />
                </div>
                <div class="form-group">
                    <label for="email">Email:<span class="text-danger">*</span></label>
                    <input type="email" id="email"  th:value="${email}" readonly/>
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Phone Number:<span class="text-danger">*</span></label>
                    <input type="tel" id="phoneNumber"  th:value="${phoneNumber}" readonly/>
                </div>
            </div>
        </fieldset>

        <hr class="separator">

        <fieldset id="selections">
            <legend>Selections</legend>
            <div class="form-row" id="selection1"> <!-- Set an id for the first selection row -->
                <div class="form-group1">
                    <label for="nationalities">Nationalities:<span class="text-danger">*</span></label>
                    <select id="nationalities" name="nationalityId" class="form-control" required>
                        <option value="">--SELECT NATIONALITY--</option>
                        <option th:each="nationality : ${nationalities}" th:value="${nationality.nationalityId}"
                                th:text="${nationality.nationalityType}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="categories">Categories:<span class="text-danger">*</span></label>
                    <select id="categories" name="categoryId" class="form-control" required>
                        <option value="">--SELECT CATEGORY--</option>
                        <option th:each="category : ${categories}" th:value="${category.categoryId}"
                                th:text="${category.categoryName}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="pricePerPerson">Price per Person:</label>
                    <input type="text" id="pricePerPerson"  readonly />
                </div>
                <div class="form-group1">
                    <label for="numberOfPeople">No. of People:<span class="text-danger">*</span></label>
                    <input type="number" id="numberOfPeople" class="number-of-people" required min="1" oninput="validateNumberOfPeople()" onchange="calculateFees()"/>

                </div>

            </div>
            <div class="button-group">
                <button type="button" class="btn btn-primary addFields">Add</button> <!-- Use class instead of id for add button -->
            </div>
        </fieldset>

        <hr class="separator">

        <fieldset>
            <legend>Total Details</legend>
            <div class="form-row">
                <div class="form-group-half">
                    <label for="totalPersons">Total Persons:</label>
                    <input type="number" id="totalPersons" th:field="*{totalPersons}" required min="1" readonly/>
                </div>
                <div class="form-group-half">
                    <label for="totalCameras">Total Cameras:</label>
                    <input type="number" id="totalCameras" th:field="*{totalCameras}" required  min="0"/>
                </div>
                <div class="form-group-half">
                    <label for="fees">Fees:</label>
                    <input type="text" id="fees" readonly onchange="calculateFees()"/>
                </div>
            </div>
            <div class="form-row" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="totalAmount">Total Amount:</label>
                    <input type="text" id="totalAmount" th:field="*{totalAmount}" required style="width: calc(50% - 10px);" />
                </div>
            </div>
        </fieldset>
        <input type="submit"  value="Proceed" />
        <input type="hidden" th:name="ticketId" th:value="${theTicket.id}" required />
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    //Fees calculation based on different nationality and categories
    // Function to calculate fees by sending data to backend controller
    function calculateFees() {
        // Send AJAX request to backend controller to calculate fees
        $.ajax({
            url: '/fetchFee', // Replace with your backend endpoint URL
            method: 'GET', // Use GET request to fetch fees from the server
            contentType: 'application/json',
            success: function(response) {
                // Update the fees field with the calculated total fees from the response
                $("#fees").val(response.totalFees);
            },
            error: function(xhr, status, error) {
                console.error('Error calculating fees:', error);
            }
        });
    }

    // Call calculateFees() whenever there is a change in nationality, category, or number of people
    $(document).on("change", ".form-group1 select, .number-of-people", function() {
        calculateFees();
    });

    //For natinality and category and totalperson calculation
    $(document).ready(function() {
        var counter = 1;

        // Function to add fields dynamically
        $(".addFields").click(function() {
            counter++;
            var newFields = $("#selection1").clone(); // Clone the container for nationality and category
            newFields.find("select").val(""); // Clear select values

            // Clear the value of the "No. of People" field
            newFields.find("#numberOfPeople").val("");

            // Remove existing "Delete" button before appending
            newFields.find('.removeFields').remove();

            // Add delete button
            var deleteButton = $("<button/>", {
                type: "button",
                class: "btn btn-danger removeFields",
                text: "Delete"
            });
            deleteButton.appendTo(newFields);

            newFields.appendTo("#selections"); // Append the cloned container to the form
        });


        // Function to remove fields dynamically
        $(document).on("click", ".removeFields", function() {
            $(this).closest('.form-row').remove(); // Remove the closest form-row
            counter--;

            // Recalculate total persons when removing a row
            calculateTotalPersons();
        });

        // Check for existing combinations when selecting nationality and category
        $(document).on("change", ".form-group1 select", function() {
            var nationalityId = $(this).closest(".form-row").find("#nationalities").val();
            var categoryId = $(this).closest(".form-row").find("#categories").val();
            var existingCombination = false;

            // Check if the combination already exists
            $("#selections .form-row").not($(this).closest(".form-row")).each(function() {
                if ($(this).find("#nationalities").val() == nationalityId &&
                    $(this).find("#categories").val() == categoryId) {
                    existingCombination = true;
                    return false; // Break the loop
                }
            });

            if (existingCombination) {
                alert("The selected combination already exists.");
                $(this).val(""); // Reset the select value
            }

            // Recalculate total persons when changing a selection
            calculateTotalPersons();
        });

        // Calculate total persons
        function calculateTotalPersons() {
            var totalPersons = 0;

            // Sum up the number of people in each row
            $(".number-of-people").each(function() {
                var numberOfPeople = parseInt($(this).val());
                if (!isNaN(numberOfPeople)) {
                    totalPersons += numberOfPeople;
                }
            });

            // Update the total persons field
            $("#totalPersons").val(totalPersons);
        }

        // Bind event listener to number of people input
        $(document).on("input", ".number-of-people", function() {
            calculateTotalPersons();
        });
    });

    function validateNumberOfPeople() {
        var numberOfPeople = document.getElementById('numberOfPeople').value;

        // Check if the number of people is not empty and not equal to 0
        if (numberOfPeople !== "" && numberOfPeople !== "0") {
            calculateTotalPersons(); // Calculate total persons if a valid value is entered
        } else {
            document.getElementById('totalPersons').value = ""; // Clear total persons if the number of people is empty or 0
        }
    }

    ///NonWorkingDays
    $(document).ready(function() {
        var establishmentId = $('#establishmentId').val();
        console.log("Establishment ID:", establishmentId);

        $.ajax({
            url: '/fetchNonWorkingDays/' + establishmentId,
            method: 'GET',
            success: function(response) {
                console.log("Success response:", response);
                // Extract non-working dates and reasons
                var nonWorkingDates = [];
                $.each(response, function(index, item) {
                    nonWorkingDates.push(item.nonWorkingDate); // Assuming nonWorkingDate is the field containing the date
                });

                console.log("Non-working dates:", nonWorkingDates);

                // Disable non-working dates
                $('#dateTime').on('input', function() {
                    var selectedDate = $(this).val();
                    if (nonWorkingDates.includes(selectedDate)) {
                        alert("This date is closed due to: " + response[nonWorkingDates.indexOf(selectedDate)].reason + "Please select another date");
                        $(this).val(''); // Clear the selected date
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching non-working dates:', error);
            }
        });
    });
    // Function to fetch fee per person based on selected nationality, category, and establishment
    function fetchPricePerPerson() {
        var establishmentId = $("#establishmentId").val();
        var nationalityId = $("#nationalities").val();
        var categoryId = $("#categories").val();

        // Send AJAX request to backend controller to fetch fee per person
        $.ajax({
            url: '/fetchPricePerPerson', // Replace with your backend endpoint URL
            method: 'GET',
            data: {
                establishmentId: establishmentId,
                nationalityId: nationalityId,
                categoryId: categoryId
            },
            success: function(response) {
                // Update the price per person field with the fetched fee
                $("#pricePerPerson").val(response.pricePerPerson);
            },
            error: function(xhr, status, error) {
                console.error('Error fetching price per person:', error);
            }
        });
    }

    // Call fetchPricePerPerson() whenever there is a change in nationality, category, or establishment
    $(document).on("change", "#establishmentId, #nationalities, #categories", function() {
        fetchPricePerPerson();
    });

    // $(document).ready(function() {
    //     // Event listener for form submission
    //     $("#ticketForm").submit(function(event) {
    //         // Prevent the default form submission
    //         event.preventDefault();
    //
    //         // Capture form data
    //         var formData = $(this).serialize();
    //
    //         // Redirect to ticket confirmation page with form data as URL parameters
    //         window.location.href = "/ticketConfirmation?" + formData;
    //     });
    // });


</script>


</body>
</html>

