<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Welcome User</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Custom Styles */
        body {
            padding: 20px;
        }

        .container-form {
            max-width: 80%;
            margin: 50px auto 20px; /* Add gap between navbar and form */
            background: #f0f0f0; /* Change background color */
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 0px 20px 0px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
            padding: 5px;
            width: 50%;
        }
        .form-group1 {
            margin-bottom: 15px;
            padding: 5px;
            /* Adjust the width as needed */
            width: calc(20% - 10px); /* Set each form group to occupy one-third of the container width */
        }
        #pricePerPerson {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #f9f9f9; /* Background color for read-only input */
            cursor: not-allowed; /* Disable cursor for read-only input */
        }


        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        input[type="submit"] {
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            width: 20%; /* Adjust the width as needed */
            margin-left: auto; /* Align to the right */
            display: block; /* Ensure it is a block-level element */
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }

        .add-button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .separator {
            width: 100%;
            border-top: 2px solid #ccc;
            margin: 20px 0;
        }

        h3 {
            text-align: center; /* Center align the header */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .form-group-half {
            width: calc(25% - 10px);
            /* Adjust width as needed and consider margin */
        }
        .removeFields {
            margin-top: 33px;
            height: 40px; /* Adjust the height as needed */
            line-height: 1; /* Align the text vertically */
            padding: 10px 10px; /* Add padding to the button */
        }


    </style>
</head>
<body>

<div th:replace="fragments/userNaveMenu :: header"></div>

<div class="container-form">
    <h3>Welcome to <span th:text="${establishment.name}"></span></h3> <!-- Centered header -->

    <form th:action="@{'/processCheckoutForm/' + ${establishment.establishmentId}}" th:object="${theTicket}" method="POST" onsubmit="return validateForm()">
    <input type="hidden" id="establishmentId" th:name="establishmentId" th:value="${establishment.establishmentId}" />
        <hr class="separator">

        <fieldset>
            <legend>Personal Information</legend>
            <div class="form-row">
                <div class="form-group">
                    <label for="dateTime">Date:<span class="text-danger">*</span></label>
                    <input type="date" id="dateTime" th:field="*{dateTime}" required/>
                </div>
                <div class="form-group">
                    <label for="name">Name:<span class="text-danger">*</span></label>
                    <input type="text" id="name" th:field="*{name}" required />
                </div>
                <div class="form-group">
                    <label for="email">Email:<span class="text-danger">*</span></label>
                    <input type="email" id="email" th:field="*{email}"/>
<!--                    <input type="email" id="email"  th:value="${email}" />-->
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Phone Number:<span class="text-danger">*</span></label>
                    <input type="tel" id="phoneNumber"  th:field="*{phoneNumber}"/>
                </div>

            </div>
        </fieldset>

        <hr class="separator">

        <fieldset id="selections">
            <legend>Selections</legend>
            <div class="form-row" id="selection1">
                <div class="form-group1">
                    <label for="nationalities">Nationalities:<span class="text-danger">*</span></label>
                    <select id="nationalities" name="nationalityId" class="form-control" required>
                        <option value="">--SELECT NATIONALITY--</option>
                        <option th:each="nationality : ${nationalities}" th:if="${nationality.hasEntryFee()}" th:value="${nationality.nationalityId}" th:text="${nationality.nationalityType}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="categories">Categories:<span class="text-danger">*</span></label>
                    <select id="categories" name="categoryId" class="form-control" required>
                        <option value="">--SELECT CATEGORY--</option>
                        <option th:each="category : ${categories}" th:if="${category.hasEntryFee()}" th:value="${category.categoryId}" th:text="${category.categoryName}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="pricePerPerson">Price per Person:</label>
                    <input type="text" id="pricePerPerson"  readonly />
                </div>
                <div class="form-group1">
                    <label for="numberOfPeople">No. of People:<span class="text-danger">*</span></label>
                    <input type="number" id="numberOfPeople" class="number-of-people" required min="1" step="1" oninput="validateNumberOfPeople()" onchange="calculateFees()" />
                </div>
                <div class="form-group1">
                    <label for="totalFees">Total:</label>
                    <input type="text" id="totalFees" readonly onchange="calculateFees()"/>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-primary addFields">Add</button> <!-- Use class instead of id for add button -->
            </div>
        </fieldset>


        <hr class="separator">
        <fieldset id="otherFees">
            <legend>Other Fees</legend>
            <div class="form-row" id="otherFeesRow1">
                <div class="form-group1">
                    <label for="otherFeesType">Fee Type:<span class="text-danger">*</span></label>
                    <select id="otherFeesType" name="otherFeesType" class="form-control" required>
                        <option value="">--SELECT FEES TYPE--</option>
                        <!-- Iterate over each fee type -->
                        <option th:each="otherFeesType : ${otherFeesType}"
                                th:if="${otherFeesType.hasFees()}"
                                th:value="${otherFeesType.otherFeesTypeId}"
                                th:text="${otherFeesType.otherFeesType}"></option>
                    </select>
                </div>


                <div class="form-group1">
                    <label for="numberOfItems">No. of Items:<span class="text-danger">*</span></label>
                    <input type="number" id="numberOfItems" class="number-of-items" required min="1" step="1" onchange="calculateOtherFees()" />
                </div>
                <div class="form-group1">
                    <label for="feesPerItem">Fees per Item:</label>
                    <input type="text" id="feesPerItem" readonly />
                </div>
                <div class="form-group1">
                    <label for="totalItemFees">Total Item Fees:</label>
                    <input type="text" id="totalItemFees" readonly onchange="calculateOtherFees()"/>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-primary addOtherFeesFields">Add More</button>
            </div>

        </fieldset>

        <hr class="separator">

        <fieldset>
            <legend>Total Details</legend>
            <div class="form-row">
                <div class="form-group-half">
                    <label for="totalPersons">Total Persons:</label>
                    <input type="number" id="totalPersons" th:field="*{totalPersons}" required min="1" readonly/>
                </div>
                <div class="form-group-half">
                    <label for="totalItems">Total Items:</label>
                    <input type="number" id="totalItems" th:field="*{totalItems}" required min="0"/>
                </div>

                <div class="form-group-half">
                    <label for="fees">Fees:</label>
                    <input type="text" id="fees" readonly />
                </div>
                <div class="form-group-half">
                    <label for="itemFees">Item Fees:</label>
                    <input type="text" id="itemFees" class="item-fees" readonly onchange="calculateOtherFees()" style="width: calc(50% - 10px);" />
                </div>
            </div>
            <div class="form-row" style="margin-top: 15px;">
                <div class="form-group">
                    <label for="totalAmount">Total Amount:</label>
                    <input type="text" id="totalAmount" th:field="*{totalAmount}" required style="width: calc(50% - 10px);" />
                </div>
            </div>
        </fieldset>
        <input type="submit"  value="Proceed" />
        <input type="hidden" th:name="ticketId" th:value="${theTicket.id}" required />
        <!-- Modal -->
        <div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="ticketModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ticketModalLabel">Ticket Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Ticket details will be displayed here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Confirm</button>
                    </div>
                </div>
            </div>
        </div>

    </form>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    // Function to calculate fees and update the pricePerPerson field
    function calculateFees() {
        var totalFees = 0;

        $(".form-row").each(function() {
            var establishmentId = $("#establishmentId").val();
            var nationalityId = $(this).find("#nationalities").val();
            var categoryId = $(this).find("#categories").val();
            var numberOfPeople = $(this).find("#numberOfPeople").val();

            // Send AJAX request to backend controller to fetch total fees
            $.ajax({
                url: '/fetchFee',
                method: 'GET',
                data: {
                    nationalityId: nationalityId,
                    categoryId: categoryId,
                    establishmentId: establishmentId,
                    numberOfPeople: numberOfPeople
                },
                success: function(response) {
                    // Update the total fees field with the fetched total fees
                    $(this).find("#totalFees").val(response.totalFees);

                    // Update the price per person field with the fetched entry fee
                    $(this).find("#pricePerPerson").val(response.entryFee);

                    // Add the fetched total fees to the running total
                    totalFees += parseFloat(response.totalFees);

                    // Update the Fees field with the total fees
                    $("#fees").val(totalFees.toFixed(2));
                    calculateTotalAmount();

                }.bind(this), // Bind the current context to use inside the success callback
                error: function(xhr, status, error) {
                    console.error('Error fetching/calculating fees:', error);
                }
            });
        });
    }

    // Call calculateFees() whenever there is a change in nationality, category, establishment, or number of people
    $(document).on("change", "#establishmentId, #nationalities, #categories, #numberOfPeople", function() {
        calculateFees();
    });

    //For natinality and category and totalperson calculation
    $(document).ready(function() {
        var counter = 1;


        // Function to add fields dynamically
        $(document).on("click", ".addFields", function() {
            var newFields = $("#selection1").clone(); // Clone the container for nationality and category
            newFields.find("select").val(""); // Clear select values

            // Clear the value of the "No. of People" field
            newFields.find("#numberOfPeople").val("");
            newFields.find("#pricePerPerson").val("");
            newFields.find("#totalFees").val("");

            // Remove existing "Delete" button before appending
            newFields.find('.removeFields').remove();

            // Add delete button
            var deleteButton = $("<button/>", {
                type: "button",
                class: "btn btn-danger removeFields",
                text: "Delete"
            });
            deleteButton.appendTo(newFields);

            newFields.appendTo("#selections"); // Append the cloned container to the form
        });
            // Bind event listener to number of people input for the newly added row
        // Function to remove fields dynamically
        $(document).on("click", ".removeFields", function() {
            $(this).closest('.form-row').remove(); // Remove the closest form-row
            calculateFees();

            // Recalculate total persons when removing a row
            calculateTotalPersons();
        });

        // Check for existing combinations when selecting nationality and category
        $(document).on("change", ".form-group1 select", function() {
            calculateFees();
        });

        // Function to remove fields dynamically
        $(document).on("click", ".removeFields", function() {
            $(this).closest('.form-row').remove(); // Remove the closest form-row
            counter--;

            // Recalculate total persons when removing a row
            calculateTotalPersons();
        });




        // Check for existing combinations when selecting nationality and category
        $(document).on("change", ".form-group1 select", function() {
            var nationalityId = $(this).closest(".form-row").find("#nationalities").val();
            var categoryId = $(this).closest(".form-row").find("#categories").val();
            var existingCombination = false;

            // Check if the combination already exists with the same category
            $("#selections .form-row").not($(this).closest(".form-row")).each(function() {
                if ($(this).find("#nationalities").val() == nationalityId &&
                    $(this).find("#categories").val() == categoryId) {
                    existingCombination = true;
                    return false; // Break the loop
                }
            });

            if (existingCombination) {
                alert("The selected combination already exists with the same category.");
                $(this).val(""); // Reset the select value
            }

            // Recalculate total persons when changing a selection
            calculateTotalPersons();
        });

        // Calculate total persons
        function calculateTotalPersons() {
            var totalPersons = 0;

            // Sum up the number of people in each row
            $(".number-of-people").each(function() {
                var numberOfPeople = parseInt($(this).val());
                if (!isNaN(numberOfPeople)) {
                    totalPersons += numberOfPeople;
                }
            });

            // Update the total persons field
            $("#totalPersons").val(totalPersons);
        }

        // Bind event listener to number of people input
        $(document).on("input", ".number-of-people", function() {
            calculateTotalPersons();
        });
    });

    function validateNumberOfPeople() {
        var numberOfPeople = document.getElementById('numberOfPeople').value;

        // Check if the number of people is not empty and not equal to 0
        if (numberOfPeople !== "" && numberOfPeople !== "0") {
            calculateTotalPersons(); // Calculate total persons if a valid value is entered
        } else {
            document.getElementById('totalPersons').value = ""; // Clear total persons if the number of people is empty or 0
        }
    }

    ///NonWorkingDays
    $(document).ready(function() {
        var establishmentId = $('#establishmentId').val();
        console.log("Establishment ID:", establishmentId);

        $.ajax({
            url: '/fetchNonWorkingDays/' + establishmentId,
            method: 'GET',
            success: function(response) {
                console.log("Success response:", response);
                // Extract non-working dates and reasons
                var nonWorkingDates = [];
                $.each(response, function(index, item) {
                    nonWorkingDates.push(item.nonWorkingDate); // Assuming nonWorkingDate is the field containing the date
                });

                console.log("Non-working dates:", nonWorkingDates);

                // Disable non-working dates
                $('#dateTime').on('input', function() {
                    var selectedDate = $(this).val();
                    if (nonWorkingDates.includes(selectedDate)) {
                        alert("This date is closed due to: " + response[nonWorkingDates.indexOf(selectedDate)].reason + "Please select another date");
                        $(this).val(''); // Clear the selected date
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching non-working dates:', error);
            }
        });
    });
</script>
<script>
    // $(document).ready(function() {
    //     // Event listener for form submission
    //     $("form").submit(function(event) {
    //         event.preventDefault(); // Prevent the default form submission
    //
    //         // Capture form data
    //         var formData = $(this).serializeArray();
    //         var modalBody = $(".modal-body");
    //
    //         // Clear previous content
    //         modalBody.empty();
    //
    //         modalBody.append("<p> Date: " + $("#dateTime").val())
    //         modalBody.append("<p> Name: " + $("#name").val())
    //         modalBody.append("<p> Email: " + $("#email").val())
    //         modalBody.append("<p> PhoneNumber: " + $("#phoneNumber").val())
    //         modalBody.append("<p> Nationality: " + $("#nationalities").val())
    //         modalBody.append("<p> Category: " + $("#categories").val())
    //         modalBody.append("<p> Price Per Person: " + $("#pricePerPerson").val())
    //         modalBody.append("<p> No Of People: " + $("#numberOfPeople").val())
    //         modalBody.append("<p> Total: " + $("#totalFees").val())
    //         modalBody.append("<p> Total Person: " + $("#totalPersons").val())
    //         modalBody.append("<p> Total Cameras: " + $("#totalCameras").val())
    //         modalBody.append("<p> Fees: " + $("#fees").val())
    //         modalBody.append("<p> Total Amount: " + $("#totalAmount").val())
    //
    //         // Show the modal
    //         $("#ticketModal").modal("show");
    //     });
    //
    //     // Event listener for modal confirmation
    //     $("#ticketModal .btn-secondary").click(function() {
    //         // Redirect to the ticket download page
    //         window.location.href = "ticketDownload.html";
    //     });
    // });
</script>
<script>
    function calculateOtherFees() {
        var totalItemFees = 0;

        // Loop through each form row
        $(".form-row").each(function() {
            var establishmentId = $("#establishmentId").val();
            var otherFeesTypeId = $(this).find("#otherFeesType").val(); // Fetch other fees type for each row
            var numberOfItems = $(this).find("#numberOfItems").val(); // Fetch number of items for each row

            // Send AJAX request to backend controller to fetch original fees
            $.ajax({
                url: '/fetchOtherFees',
                method: 'GET',
                data: {
                    establishmentId: establishmentId,
                    otherFeesTypeId: otherFeesTypeId,
                    numberOfItems: numberOfItems
                },
                success: function(response) {
                    // Update the fees per item field with the fetched fees for the current row
                    $(this).find("#feesPerItem").val(response.fees);

                    // Update the total item fees field with the fetched total fees for the current row
                    $(this).find("#totalItemFees").val(response.totalItemFees);

                    // Add the fetched total fees to the running total
                    totalItemFees += parseFloat(response.totalItemFees);

                    // Update the Item Fees field with the total item fees
                    $("#itemFees").val(totalItemFees.toFixed(2));

                    // Recalculate total items for all rows
                    calculateTotalItems();
                    calculateTotalAmount();
                }.bind(this),
                error: function(xhr, status, error) {
                    console.error('Error fetching original fees:', error);
                }
            });
        });
    }

    // Call calculateOtherFees() whenever there is a change in establishmentId, otherFeesType, or numberOfItems
    $(document).on("change", "#establishmentId, #otherFeesType, #numberOfItems", function() {
        calculateOtherFees();
    });

    // Function to calculate total items
    function calculateTotalItems() {
        var totalItems = 0;

        // Sum up the number of items in each row
        $(".number-of-items").each(function() {
            var items = parseInt($(this).val());
            if (!isNaN(items)) {
                totalItems += items;
            }
        });

        // Update the Total Items field
        $("#totalItems").val(totalItems);
    }

    // Call calculateTotalItems() whenever there is a change in the number of items
    $(document).on("input", ".form-group1 #numberOfItems", function() {
        calculateTotalItems();
    });

    $(document).on("click", ".addOtherFeesFields", function() {
        var newFields = $("#otherFeesRow1").clone(); // Clone the container for other fees
        newFields.find("input").val(""); // Clear input values
        newFields.find("#numberOfItems").val("");
        newFields.find("#feesPerItem").val("");
        newFields.find("#totalItemFees").val("");

        // Remove existing "Delete" button before appending
        newFields.find('.removeFields').remove();

        // Add delete button
        var deleteButton = $("<button/>", {
            type: "button",
            class: "btn btn-danger removeFields",
            text: "Delete"
        });
        deleteButton.appendTo(newFields);

        // Insert the new row before the "Add Other Fees" button
        $(this).before(newFields);

        // Bind event listeners for new row inputs
        newFields.find("#otherFeesType, #numberOfItems").on("change", function() {
            calculateOtherFees();
        });
    });


    // Function to remove other fees fields dynamically
    $(document).on("click", ".removeFields", function() {
        $(this).closest('.form-row').remove();
        calculateOtherFees(); // Recalculate other fees when removing a row
        calculateTotalItems(); // Recalculate total items when removing a row
    });

    // Check for existing combinations when selecting other fees type
    $(document).on("change", ".form-group1 select", function() {
        var otherFeesTypeId = $(this).closest(".form-row").find("#otherFeesType").val();
        var existingCombination = false;

        // Check if the selected fee type already exists in any other row
        $("#otherFees .form-row").not($(this).closest(".form-row")).each(function() {
            if ($(this).find("#otherFeesType").val() == otherFeesTypeId) {
                existingCombination = true;
                return false; // Break the loop
            }
        });

        if (existingCombination) {
            alert("The selected fee type has already been chosen. Please select another fee type.");
            $(this).val(""); // Reset the select value
        }
    });
    // Function to calculate total amount
    function calculateTotalAmount() {
        // Parse the values of Fees and Item Fees fields
        var fees = parseFloat($("#fees").val());
        var itemFees = parseFloat($("#itemFees").val());

        // Check if fees or itemFees is NaN (not a number)
        if (isNaN(fees)) {
            fees = 0; // Set fees to 0 if it's not present
        }
        if (isNaN(itemFees)) {
            itemFees = 0; // Set itemFees to 0 if it's not present
        }

        // Calculate the total amount by summing Fees and Item Fees
        var totalAmount = fees + itemFees;

        // Update the Total Amount field with the calculated value
        $("#totalAmount").val(totalAmount.toFixed(2));
    }

</script>
</body>
</html>

