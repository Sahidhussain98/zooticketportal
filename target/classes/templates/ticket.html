<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Welcome User</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Custom Styles */
        body {
            padding: 20px;
        }

        .container-form {
            max-width: 80%;
            margin: 50px auto 20px; /* Add gap between navbar and form */
            background: #f0f0f0; /* Change background color */
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 0px 20px 0px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
            padding: 5px;
            width: 50%;
        }

        .form-group1 {
            margin-bottom: 15px;
            padding: 5px;
            width: calc(20% - 10px);
        }

        #pricePerPerson {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #f9f9f9; /* Background color for read-only input */
            cursor: not-allowed; /* Disable cursor for read-only input */
        }

        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        input[type="submit"] {
            background-color: #4caf50;
            color: white;
            cursor: pointer;
            width: 20%; /* Adjust the width as needed */
            margin-left: auto; /* Align to the right */
            display: block; /* Ensure it is a block-level element */
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }

        .add-button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .separator {
            width: 100%;
            border-top: 2px solid #ccc;
            margin: 20px 0;
        }

        h3 {
            text-align: center; /* Center align the header */
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .form-group-half {
            width: calc(25% - 10px);
        }

        .removeFields {
            margin-left: 4px;
            margin-bottom:5px;
            height: 40px; /* Adjust the height as needed */
            line-height: 1; /* Align the text vertically */
            padding: 10px 10px; /* Add padding to the button */
        }

        /* Styles for Other Fees section */
        .feeEntryRow {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            width: 100%;
        }

        .feeEntry {
            flex: 1;
            margin-right: 10px;
        }

        .feeEntry:last-child {
            margin-right: 0;
        }

        /* Align text boxes in Total Details section */
        .form-group-quarter {
            width: calc(25% - 10px); /* Adjust width as needed */
        }
    </style>
</head>
<body>

<div th:replace="fragments/userNaveMenu :: header"></div>

<div class="container-form">
    <h3>Welcome to <span th:text="${establishment.name}"></span></h3> <!-- Centered header -->

    <form th:action="@{'/processCheckoutForm/' + ${establishment.establishmentId}}" th:object="${theTicket}" method="POST" onsubmit="return validateForm()">
        <input type="hidden" id="establishmentId" th:name="establishmentId" th:value="${establishment.establishmentId}" />
        <hr class="separator">

        <fieldset>
            <legend>Personal Information</legend>
            <div class="form-row">
                <div class="form-group">
                    <label for="dateTime">Date:<span class="text-danger">*</span></label>
                    <input type="date" id="dateTime" th:field="*{dateTime}" required />
                </div>
                <div class="form-group">
                    <label for="name">Name:<span class="text-danger">*</span></label>
                    <input type="text" id="name" th:field="*{name}" required />
                </div>
                <div class="form-group">
                    <label for="email">Email:<span class="text-danger">*</span></label>
                    <input type="email" id="email" th:field="*{email}" />
                </div>
                <div class="form-group">
                    <label for="phoneNumber">Phone Number:<span class="text-danger">*</span></label>
                    <input type="tel" id="phoneNumber" th:field="*{phoneNumber}" />
                </div>
            </div>
        </fieldset>

        <hr class="separator">

        <fieldset id="selections">
            <legend>Selections</legend>
            <div class="form-row" id="selection1">
                <div class="form-group1">
                    <label for="nationalities">Nationalities:<span class="text-danger">*</span></label>
                    <select id="nationalities" name="nationalityId" required>
                        <option value="">SELECT NATIONALITY</option>
                        <option th:each="nationality : ${nationalities}" th:if="${nationality.hasEntryFee()}" th:value="${nationality.nationalityId}" th:text="${nationality.nationalityType}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="categories">Categories:<span class="text-danger">*</span></label>
                    <select id="categories" name="categoryId" required>
                        <option value="">--SELECT CATEGORY--</option>
                        <option th:each="category : ${categories}" th:if="${category.hasEntryFee()}" th:value="${category.categoryId}" th:text="${category.categoryName}"></option>
                    </select>
                </div>
                <div class="form-group1">
                    <label for="pricePerPerson">Price per Person:</label>
                    <input type="text" id="pricePerPerson" readonly />
                </div>
                <div class="form-group1">
                    <label for="numberOfPeople">No. of People:<span class="text-danger">*</span></label>
                    <input type="number" id="numberOfPeople" class="number-of-people" required min="1" step="1" oninput="validateNumberOfPeople()" onchange="calculateFees()" />
                </div>
                <div class="form-group1">
                    <label for="totalFees">Total:</label>
                    <input type="text" id="totalFees" readonly onchange="calculateFees()" />
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-primary addFields">Add More</button>
            </div>
        </fieldset>

        <hr class="separator">
        <fieldset id="otherFees">
            <legend>Other Fees</legend>
            <div id="feesList" class="form-row">
                <div class="feeEntryRow">
                    <div class="feeEntry">
                        <label for="feeType">Fee Type:</label>
                        <select id="feeType" name="feeType" class="feeType" required>
                            <option value="">SELECT FEE TYPE</option>
                            <option th:each="otherFees : ${otherFees}" th:value="${otherFees.feesType}" th:text="${otherFees.feesType}"></option>
                        </select>
                    </div>
                    <div class="feeEntry">
                        <label for="feePerItem">Fee per Item:</label>
                        <input type="number" id="feePerItem" readonly />
                    </div>
                    <div class="feeEntry">
                        <label for="numItems">Number of Items:</label>
                        <input type="number" id="numItems" required min="1" />
                    </div>
                    <div class="feeEntry">
                        <label for="totalItemFees">Total Item Fees:</label>
                        <input type="number" id="totalItemFees" readonly />
                    </div>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="btn btn-primary addOtherFees">Add More Fees</button>
            </div>
        </fieldset>
        <hr class="separator">
        <fieldset>
            <legend>Total Details</legend>
            <div class="form-row">
                <div class="form-group-quarter">
                    <label for="totalPersons">Total Persons:</label>
                    <input type="number" id="totalPersons" th:field="*{totalPersons}" required min="1" readonly />
                </div>
                <div class="form-group-quarter">
                    <label for="totalItems">Total Items:</label>
                    <input type="number" id="totalItems" th:field="*{totalItems}" required min="0" />
                </div>
                <div class="form-group-quarter">
                    <label for="fees">Fees:</label>
                    <input type="text" id="fees" readonly />
                </div>
                <div class="form-group-quarter">
                    <label for="itemFees">Item Fees:</label>
                    <input type="text" id="itemFees" class="item-fees" readonly onchange="calculateOtherFees()" />
                </div>
            </div>
            <div class="form-row" style="margin-top: 15px;">
                <div class="form-group-quarter">
                    <label for="totalAmount">Total Amount:</label>
                    <input type="text" id="totalAmount" th:field="*{totalAmount}" required />
                </div>
            </div>
        </fieldset>
        <input type="submit" value="Proceed" />
        <input type="hidden" th:name="ticketId" th:value="${theTicket.id}" required />
        <!-- Modal -->
        <div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="ticketModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="ticketModalLabel">Ticket Details</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- Ticket details will be displayed here -->
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
    // Function to calculate fees and update the pricePerPerson field
    function calculateFees() {
        var totalFees = 0;

        $(".form-row").each(function() {
            var establishmentId = $("#establishmentId").val();
            var nationalityId = $(this).find("#nationalities").val();
            var categoryId = $(this).find("#categories").val();
            var numberOfPeople = $(this).find("#numberOfPeople").val();

            // Send AJAX request to backend controller to fetch total fees
            $.ajax({
                url: '/fetchFee',
                method: 'GET',
                data: {
                    nationalityId: nationalityId,
                    categoryId: categoryId,
                    establishmentId: establishmentId,
                    numberOfPeople: numberOfPeople
                },
                success: function(response) {
                    // Update the total fees field with the fetched total fees
                    $(this).find("#totalFees").val(response.totalFees);

                    // Update the price per person field with the fetched entry fee
                    $(this).find("#pricePerPerson").val(response.entryFee);

                    // Add the fetched total fees to the running total
                    totalFees += parseFloat(response.totalFees);

                    // Update the Fees field with the total fees
                    $("#fees").val(totalFees.toFixed(2));
                    calculateTotalAmount();

                }.bind(this), // Bind the current context to use inside the success callback
                error: function(xhr, status, error) {
                    console.error('Error fetching/calculating fees:', error);
                }
            });
        });
    }

    // Call calculateFees() whenever there is a change in nationality, category, establishment, or number of people
    $(document).on("change", "#establishmentId, #nationalities, #categories, #numberOfPeople", function() {
        calculateFees();
    });

    // For nationality and category and total person calculation
    $(document).ready(function() {
        var counter = 1;

        // Function to add fields dynamically
        $(document).on("click", ".addFields", function() {
            var newFields = $("#selection1").clone(); // Clone the container for nationality and category
            newFields.find("select").val(""); // Clear select values

            // Clear the value of the "No. of People" field
            newFields.find("#numberOfPeople").val("");
            newFields.find("#pricePerPerson").val("");
            newFields.find("#totalFees").val("");

            // Remove existing "Delete" button before appending
            newFields.find('.removeFields').remove();

            // Add delete button
            var deleteButton = $("<button/>", {
                type: "button",
                class: "btn btn-danger removeFields",
                text: "Delete",
            });
            deleteButton.appendTo(newFields);

            newFields.insertBefore($(this).closest(".button-group")); // Insert the new fields before the "Add" button
        });

        // Bind event listener to number of people input for the newly added row
        // Function to remove fields dynamically
        $(document).on("click", ".removeFields", function() {
            $(this).closest('.form-row').remove(); // Remove the closest form-row
            calculateFees();

            // Recalculate total persons when removing a row
            calculateTotalPersons();
        });

        // Check for existing combinations when selecting nationality and category
        $(document).on("change", ".form-group1 select", function() {
            calculateFees();
        });

        // Function to remove fields dynamically
        $(document).on("click", ".removeFields", function() {
            $(this).closest('.form-row').remove(); // Remove the closest form-row
            counter--;

            // Recalculate total persons when removing a row
            calculateTotalPersons();
        });

        // Check for existing combinations when selecting nationality and category
        $(document).on("change", ".form-group1 select", function() {
            var nationalityId = $(this).closest(".form-row").find("#nationalities").val();
            var categoryId = $(this).closest(".form-row").find("#categories").val();
            var existingCombination = false;

            // Only check for duplicate if both nationality and category are selected
            if (nationalityId && categoryId) {
                // Check if the combination already exists with the same category
                $("#selections .form-row").not($(this).closest(".form-row")).each(function() {
                    if ($(this).find("#nationalities").val() == nationalityId &&
                        $(this).find("#categories").val() == categoryId) {
                        existingCombination = true;
                        return false; // Break the loop
                    }
                });
            }

            if (existingCombination) {
                alert("The selected combination already exists with the same category.");
                $(this).val(""); // Reset the select value
            }

            // Recalculate total persons when changing a selection
            calculateTotalPersons();
        });

        // Calculate total persons
        function calculateTotalPersons() {
            var totalPersons = 0;

            // Sum up the number of people in each row
            $(".number-of-people").each(function() {
                var numberOfPeople = parseInt($(this).val());
                if (!isNaN(numberOfPeople)) {
                    totalPersons += numberOfPeople;
                }
            });

            // Update the total persons field
            $("#totalPersons").val(totalPersons);
        }

        // Bind event listener to number of people input
        $(document).on("input", ".number-of-people", function() {
            calculateTotalPersons();
        });
    });

    function validateNumberOfPeople() {
        var numberOfPeople = document.getElementById('numberOfPeople').value;

        // Check if the number of people is not empty and not equal to 0
        if (numberOfPeople !== "" && numberOfPeople !== "0") {
            calculateTotalPersons(); // Calculate total persons if a valid value is entered
        } else {
            document.getElementById('totalPersons').value = ""; // Clear total persons if the number of people is empty or 0
        }
    }

    /// NonWorkingDays
    $(document).ready(function() {
        var establishmentId = $('#establishmentId').val();
        console.log("Establishment ID:", establishmentId);

        $.ajax({
            url: '/fetchNonWorkingDays/' + establishmentId,
            method: 'GET',
            success: function(response) {
                console.log("Success response:", response);
                // Extract non-working dates and reasons
                var nonWorkingDates = [];
                $.each(response, function(index, item) {
                    nonWorkingDates.push(item.nonWorkingDate); // Assuming nonWorkingDate is the field containing the date
                });

                console.log("Non-working dates:", nonWorkingDates);

                // Disable non-working dates
                $('#dateTime').on('input', function() {
                    var selectedDate = $(this).val();
                    if (nonWorkingDates.includes(selectedDate)) {
                        alert("This date is closed due to: " + response[nonWorkingDates.indexOf(selectedDate)].reason + "Please select another date");
                        $(this).val(''); // Clear the selected date
                    }
                });
            },
            error: function(xhr, status, error) {
                console.error('Error fetching non-working dates:', error);
            }
        });
    });
</script>
<script>
    // Handle changes to feeType
    $(document).ready(function() {
        // Handle changes to feeType
        $(document).on('change', '.feeType', function() {
            const feeType = $(this).val();
            const feeEntryRow = $(this).closest('.feeEntryRow');
            const feePerItemElement = feeEntryRow.find('#feePerItem');
            const numItemsElement = feeEntryRow.find('#numItems');
            const totalItemFeesElement = feeEntryRow.find('#totalItemFees');
            const establishmentId = $('#establishmentId').val();

            if (feeType) {
                $.ajax({
                    type: 'GET',
                    url: '/fetchOtherFees',
                    data: {
                        feesType: feeType,
                        establishmentId: establishmentId
                    },
                    success: function(response) {
                        feePerItemElement.val(response.feePerItem);

                        // Calculate the total item fees immediately after updating fee per item
                        calculateTotalItemFees(numItemsElement, response.feePerItem, totalItemFeesElement);
                    },
                    error: function(xhr, status, error) {
                        console.error('Failed to fetch fees:', error);
                        feePerItemElement.val('');
                        totalItemFeesElement.val('');
                    }
                });
            } else {
                feePerItemElement.val('');
                totalItemFeesElement.val('');
            }
        });

        // Function to calculate and update total item fees
        function calculateTotalItemFees(numItemsElement, feePerItem, totalItemFeesElement) {
            const numItems = parseInt(numItemsElement.val(), 10);
            if (!isNaN(numItems) && numItems > 0 && !isNaN(feePerItem)) {
                const totalItemFees = numItems * feePerItem;
                totalItemFeesElement.val(totalItemFees.toFixed(2));
            } else {
                totalItemFeesElement.val('');
            }
        }

        // Update total item fees whenever the number of items changes
        $(document).on('input', '#numItems', function() {
            const numItemsElement = $(this);
            const feePerItem = parseFloat(numItemsElement.closest('.feeEntryRow').find('#feePerItem').val());
            const totalItemFeesElement = numItemsElement.closest('.feeEntryRow').find('#totalItemFees');

            calculateTotalItemFees(numItemsElement, feePerItem, totalItemFeesElement);
        });

        // DELETE BUTTON FOR OTHER FEES PART
        $(document).ready(function() {
            // Function to add other fee rows dynamically
            $(document).on("click", ".addOtherFees", function() {
                // Clone the first fee entry row
                var newRow = $(".feeEntryRow").first().clone();
                newRow.find("select").val(""); // Clear select values
                newRow.find("input").val(""); // Clear input values that are not readonly

                // Remove any existing delete buttons in the cloned row (if any exist)
                newRow.find(".removeOtherFees").remove();

                // Append the cloned row to the fees list
                newRow.appendTo("#feesList");

                // Create a new row for the delete button
                var deleteButtonRow = $("<div/>", {
                    class: "row", // Use Bootstrap's row class or any custom class for styling
                    style: "margin-top: 5px; margin-left: 2px; margin-bottom:5px"  // Add some top margin for spacing
                });

                // Create the delete button
                var deleteButton = $("<button/>", {
                    type: "button",
                    class: "btn btn-danger removeOtherFees",
                    text: "Delete"
                });

                // Append the delete button to the new row
                deleteButton.appendTo(deleteButtonRow);

                // Append the new row (with the delete button) below the new fee entry row
                deleteButtonRow.appendTo("#feesList");
            });

            // Function to remove fee entry rows dynamically along with their corresponding delete button row
            $(document).on("click", ".removeOtherFees", function() {
                var feeRow = $(this).closest('.row').prev('.feeEntryRow'); // Get the corresponding fee entry row
                $(this).closest('.row').remove(); // Remove the row containing the delete button
                feeRow.remove(); // Remove the fee entry row
            });

            // Handle changes to feeType to prevent duplicate selections
            $(document).on('change', '.feeType', function() {
                const currentFeesType = $(this).val();
                let isDuplicate = false;

                // Check other feeType elements to see if the current selection has already been made
                $('.feeType').not(this).each(function() {
                    if ($(this).val() === currentFeesType) {
                        isDuplicate = true;
                        return false; // Exit the loop if a duplicate is found
                    }
                });

                if (isDuplicate) {
                    alert('This FeesType is already selected. Please select another FeesType.');
                    $(this).val(''); // Reset the current selection if it's a duplicate
                }
            });
        });
    });
</script>
</body>
</html>
